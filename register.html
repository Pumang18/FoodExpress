<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Register - FoodExpress</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-utensils text-primary me-2"></i>
                FoodExpress
            </a>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <i class="fas fa-user-circle fa-3x text-primary"></i>
                            <h2 class="mt-3">Register</h2>
                        </div>
                        <form id="registrationForm">
                            <div class="mb-3">
                                <label for="userName" class="form-label">Name</label>
                                <input type="text" class="form-control" id="userName" required>
                                <div class="invalid-feedback">At least 5 characters required.</div>
                            </div>
                            <div class="mb-3">
                                <label for="userEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="userEmail" placeholder="example@gmail.com" required>
                                <div class="text-danger d-none" id="emailExist">Email Already Exists.</div>
                            </div>
                            <div class="mb-3">
                                <label for="userPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="userPassword" required>
                                <div class="invalid-feedback">Password must be at least 8 characters, include uppercase, lowercase, and a special character.</div>
                            </div>
                            <div class="mb-3">
                                <label for="userPhone" class="form-label">Phone</label>
                                <input type="text" class="form-control" id="userPhone" required>
                                <div class="invalid-feedback">Enter a valid 10-digit phone number.</div>
                            </div>
                            <div class="mb-3">
                                <label for="userAddress" class="form-label">Address</label>
                                <input type="text" class="form-control" id="userAddress" required>
                                <div class="invalid-feedback">At least 5 characters required.</div>
                            </div>
                            <div class="mb-3">
                                <label for="userType" class="form-label">User Type</label>
                                <select id="userType" class="form-control">
                                    <option value="">--Choose--</option>
                                    <option value="Customer">Customer</option>
                                    <option value="Owner">Restaurant Owner</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                            <div id="restaurantDetails" class="d-none">
                                <div class="mb-3">
                                    <label for="restaurantName" class="form-label">Restaurant Name</label>
                                    <input type="text" class="form-control" id="restaurantName" >
                                </div>
                                <div class="mb-3">
                                    <label for="restaurantLocation" class="form-label">Restaurant Location</label>
                                    <input type="text" class="form-control" id="restaurantLocation" >
                                </div>
                                <div class="mb-3">
                                    <label for="restaurantContact" class="form-label">Restaurant Contact</label>
                                    <input type="text" class="form-control" id="restaurantContact" >
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Register</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const apiUrlUsers = "http://localhost:3000/users";
        const apiUrlRestaurants = "http://localhost:3000/restaurants";

        const form = document.getElementById("registrationForm");
        const userName = document.getElementById("userName");
        const userEmail = document.getElementById("userEmail");
        const userPassword = document.getElementById("userPassword");
        const userPhone = document.getElementById("userPhone");
        const userAddress = document.getElementById("userAddress");
        const userType = document.getElementById("userType");
        const restaurantDetails = document.getElementById("restaurantDetails");
        const restaurantName = document.getElementById("restaurantName");
        const restaurantLocation = document.getElementById("restaurantLocation");
        const restaurantContact = document.getElementById("restaurantContact");
        const emailExist = document.getElementById("emailExist");
        let users = [];

        async function fetchUsers() {
            const response = await fetch(apiUrlUsers);
            users = await response.json();
        }
        fetchUsers();

        userType.addEventListener("change", function () {
            if (this.value === "Owner") {
                restaurantDetails.classList.remove("d-none");
            } else {
                restaurantDetails.classList.add("d-none");
            }
        });

        function validateName() {
            if (userName.value.trim().length >= 5) {
                userName.classList.add("is-valid");
                userName.classList.remove("is-invalid");
                return true;
            } else {
                userName.classList.add("is-invalid");
                userName.classList.remove("is-valid");
                return false;
            }
        }

        function validatePassword() {
            const passRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\W).{8,}$/;
            if (passRegex.test(userPassword.value)) {
                userPassword.classList.add("is-valid");
                userPassword.classList.remove("is-invalid");
                return true;
            } else {
                userPassword.classList.add("is-invalid");
                userPassword.classList.remove("is-valid");
                return false;
            }
        }

        function validatePhone() {
            const phoneRegex = /^[789]\d{9}$/;
            if (phoneRegex.test(userPhone.value.trim())) {
                userPhone.classList.add("is-valid");
                userPhone.classList.remove("is-invalid");
                return true;
            } else {
                userPhone.classList.add("is-invalid");
                userPhone.classList.remove("is-valid");
                return false;
            }
        }

        function validateAddress() {
            if (userAddress.value.trim().length >= 5) {
                userAddress.classList.add("is-valid");
                userAddress.classList.remove("is-invalid");
                return true;
            } else {
                userAddress.classList.add("is-invalid");
                userAddress.classList.remove("is-valid");
                return false;
            }
        }

        userName.addEventListener("blur", validateName);
        userPassword.addEventListener("blur", validatePassword);
        userPhone.addEventListener("blur", validatePhone);
        userAddress.addEventListener("blur", validateAddress);

        form.addEventListener("submit", async function (e) {
            e.preventDefault();

            if (!validateName() || !validatePassword() || !validatePhone() || !validateAddress()) {
                return;
            }

            const user = {
                name: userName.value.trim(),
                email: userEmail.value.trim(),
                password: userPassword.value,
                phone: userPhone.value.trim(),
                address: userAddress.value.trim(),
                userType: userType.value.trim(),
            };

            const isPresent = users.some((u) => u.email === user.email);
            if (isPresent) {
                alert("Email already exists.");
                window.location.href = "/login.html";
                
            }

            const newUser = await fetch(apiUrlUsers, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(user),
            }).then((res) => res.json());

            if (user.userType === "Owner") {
                const restaurant = {
                    name: restaurantName.value.trim(),
                    location: restaurantLocation.value.trim(),
                    contact: restaurantContact.value.trim(),
                    userId: newUser.id,
                };

                await fetch(apiUrlRestaurants, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(restaurant),
                });
            }

            form.reset();
            restaurantDetails.classList.add("d-none");
            window.location.href = "/login.html";
        });
    </script>
</body>
</html>
