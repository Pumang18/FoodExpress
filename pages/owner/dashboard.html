<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Owner Dashboard - FoodExpress</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css"
    />
    <link href="../css/styles.css" rel="stylesheet" />
  </head>
  <body>
    <div
      class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
    >
      <h1 class="h2">Dashboard</h1>
      <div class="d-flex align-items-center">
      </div>
    </div>

    
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card stats-card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted">Total Orders</h6>
                <h3 id="total-orders"></h3>
              </div>
              <i class="fas fa-shopping-bag fa-2x text-primary opacity-50"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stats-card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted">Revenue</h6>
                <h3 id="revenue"></h3>
              </div>
              <i class="fas fa-dollar-sign fa-2x text-primary opacity-50"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card stats-card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="text-muted">Avg. Order Value</h6>
                <h3 id="avg-order-value"></h3>
              </div>
              <i class="fas fa-receipt fa-2x text-primary opacity-50"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts row -->
    <div class="row mb-4">
      <div class="col-md-8">
        <div class="card chart-container h-100">
          <div class="card-header bg-white">
            <h5 class="card-title mb-0">Orders Over Time</h5>
          </div>
          <div class="card-body">
            <canvas id="ordersOverTimeChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card chart-container h-100">
          <div class="card-header bg-white">
            <h5 class="card-title mb-0">Top Categories</h5>
          </div>
          <div class="card-body d-flex align-items-center">
            <canvas id="categoryPieChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Additional charts row -->
    <div class="row mb-4">
      <div class="col-md-8">
        <div class="card chart-container h-100">
          <div class="card-header bg-white">
            <h5 class="card-title mb-0">Sales by Day of Week</h5>
          </div>
          <div class="card-body">
            <canvas id="topItemsChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      (() => {
        const restaurantId = sessionStorage.getItem("restaurantId");

        async function loadDashboardData() {
          try {
            const ordersRes = await fetch(`${apiUrl}/orders`);
            const orders = await ordersRes.json();

            const filteredOrders = orders.filter(
              (order) => String(order.restaurantId) === String(restaurantId)
            );

            const totalOrders = filteredOrders.length;

            const totalRevenue = filteredOrders.reduce(
              (sum, order) => sum + Number(order.totalAmount || 0),
              0
            );

            const avgOrderValue =
              totalOrders > 0
                ? (totalRevenue / totalOrders).toFixed(2)
                : "0.00";

            document.getElementById("total-orders").textContent = totalOrders;
            document.getElementById(
              "revenue"
            ).textContent = `₹${totalRevenue.toFixed(2)}`;
            document.getElementById(
              "avg-order-value"
            ).textContent = `₹${avgOrderValue}`;

            loadOrderRelatedData(filteredOrders);
          } catch (error) {
            console.error("Error loading dashboard data:", error);
          }
        }

        async function loadOrderRelatedData(filteredOrders) {
          try {
            const orderIds = filteredOrders.map((order) => order.id);

            const [orderItemsRes, foodItemsRes] = await Promise.all([
              fetch(`${apiUrl}/orderItems`),
              fetch(`${apiUrl}/foodItems`),
            ]);

            const orderItems = await orderItemsRes.json();
            const foodItems = await foodItemsRes.json();

            const relatedOrderItems = orderItems.filter((item) =>
              orderIds.includes(item.orderId)
            );

            const itemCountMap = {};
            relatedOrderItems.forEach((item) => {
              if (!itemCountMap[item.itemId]) {
                itemCountMap[item.itemId] = 0;
              }
              itemCountMap[item.itemId] += item.quantity;
            });

            const itemData = Object.entries(itemCountMap)
              .map(([id, qty]) => {
                const food = foodItems.find((f) => f.id == id);
                return food
                  ? { name: food.name, qty, category: food.category }
                  : null;
              })
              .filter(Boolean);

            const topItems = itemData.sort((a, b) => b.qty - a.qty).slice(0, 5);

            renderTopItemsChart(topItems);
            renderOrdersOverTimeChart(filteredOrders);
            renderItemCategoryChart(itemData);
          } catch (error) {
            console.error("Error loading related data:", error);
          }
        }

        // Top Items Chart
        function renderTopItemsChart(topItems) {
          const ctx = document.getElementById("topItemsChart").getContext("2d");
          new Chart(ctx, {
            type: "bar",
            data: {
              labels: topItems.map((item) => item.name),
              datasets: [
                {
                  label: "Quantity Sold",
                  data: topItems.map((item) => item.qty),
                  backgroundColor: "#4caf50",
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                title: {
                  display: true,
                  text: "Top 5 Selling Items",
                },
              },
            },
          });
        }

        // Orders Over Time Chart
        function renderOrdersOverTimeChart(orders) {
          const groupedByDate = {};

          orders.forEach((order) => {
            const rawDate = String(order.orderDate || "").trim();
            const dateObj = new Date(rawDate + "T00:00:00");
            if (!isNaN(dateObj)) {
              const dateStr = dateObj.toISOString().split("T")[0]; // Get 'YYYY-MM-DD'
              groupedByDate[dateStr] = (groupedByDate[dateStr] || 0) + 1;
            }
          });

          const dates = Object.keys(groupedByDate).sort();
          const values = dates.map((date) => groupedByDate[date]);

          const ctx = document
            .getElementById("ordersOverTimeChart")
            .getContext("2d");
          new Chart(ctx, {
            type: "line",
            data: {
              labels: dates,
              datasets: [
                {
                  label: "Orders",
                  data: values,
                  fill: false,
                  borderColor: "#2196f3",
                  tension: 0.1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                title: {
                  display: true,
                  text: "Orders Over Time",
                },
              },
              scales: {
                x: {
                  ticks: {
                    maxRotation: 0,
                    minRotation: 0,
                  },
                },
              },
            },
          });
        }

        //Item Category Chart
        function renderItemCategoryChart(itemData) {
          const categoryMap = {};
          console.log(itemData);
          itemData.forEach((item) => {
            if (!categoryMap[item.category]) {
              categoryMap[item.category] = 0;
            }
            categoryMap[item.category] += item.qty;
          });

          const categories = Object.keys(categoryMap);
          const quantities = Object.values(categoryMap);

          const ctx = document
            .getElementById("categoryPieChart")
            .getContext("2d");
          new Chart(ctx, {
            type: "pie",
            data: {
              labels: categories,
              datasets: [
                {
                  label: "Category Distribution",
                  data: quantities,
                  backgroundColor: [
                    "#ff6384",
                    "#36a2eb",
                    "#ffce56",
                    "#8e44ad",
                    "#2ecc71",
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                title: {
                  display: true,
                  text: "Sales by Category",
                },
              },
            },
          });
        }

        loadDashboardData();
      })();
    </script>
  </body>
</html>
