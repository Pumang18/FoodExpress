<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Reports - FoodExpress Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Reports</h1>
        <div class="mb-4">
            <input type="text" id="searchInput" class="form-control" placeholder="Search by name, email, or location">
        </div>
        <div class="row">
            <div class="col-lg mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Restaurants with Highest Revenue
                    </div>
                    <div class="card-body">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Restaurant Name</th>
                                    <th>Location</th>
                                    <th>Total Revenue (₹)</th>
                                </tr>
                            </thead>
                            <tbody id="highest-revenue-table">
                                <!-- Data will be dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users Who Order the Most -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        Users Who Order the Most
                    </div>
                    <div class="card-body">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>User Name</th>
                                    <th>Email</th>
                                    <th>Total Orders</th>
                                </tr>
                            </thead>
                            <tbody id="most-orders-table">
                                <!-- Data will be dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Items Sold per Restaurant -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header bg-warning text-white">
                        Items Sold per Restaurant
                    </div>
                    <div class="card-body">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Restaurant Name</th>
                                    <th>Location</th>
                                    <th>Items Sold</th>
                                </tr>
                            </thead>
                            <tbody id="items-sold-table">
                                <!-- Data will be dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        (async () => {
            try {
                const [orders, restaurants, users, orderItems] = await Promise.all([
                    fetch(`${apiUrl}/orders`).then(res => res.json()),
                    fetch(`${apiUrl}/restaurants`).then(res => res.json()),
                    fetch(`${apiUrl}/users`).then(res => res.json()),
                    fetch(`${apiUrl}/orderItems`).then(res => res.json())
                ]);

                generateHighestRevenueReport(orders, restaurants);
                generateMostOrdersReport(orders, users);
                generateItemsSoldReport(orderItems, orders, restaurants);

                const searchInput = document.getElementById("searchInput");
                searchInput.addEventListener("input", () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    filterTables(searchTerm, restaurants, users);
                });
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        })();

        function generateHighestRevenueReport(orders, restaurants) {
            const revenueMap = {};

            orders.forEach(order => {
                if (!revenueMap[order.restaurantId]) {
                    revenueMap[order.restaurantId] = 0;
                }
                revenueMap[order.restaurantId] += order.totalAmount;
            });

            const revenueList = Object.entries(revenueMap)
                .map(([restaurantId, totalRevenue]) => {
                    const restaurant = restaurants.find(r => r.id === restaurantId);
                    return {
                        name: restaurant?.name || "Unknown",
                        location: restaurant?.location || "N/A",
                        revenue: totalRevenue
                    };
                })
                .sort((a, b) => b.revenue - a.revenue);

            const table = document.getElementById("highest-revenue-table");
            table.innerHTML = ""; 
            revenueList.forEach((r, i) => {
                const row = `<tr>
                    <td>${i + 1}</td>
                    <td>${r.name}</td>
                    <td>${r.location}</td>
                    <td>₹${r.revenue.toLocaleString()}</td>
                </tr>`;
                table.innerHTML += row;
            });
        }

        function generateMostOrdersReport(orders, users) {
            const userOrderCount = {};

            orders.forEach(order => {
                if (!userOrderCount[order.userId]) {
                    userOrderCount[order.userId] = 0;
                }
                userOrderCount[order.userId]++;
            });

            const userList = Object.entries(userOrderCount)
                .map(([userId, count]) => {
                    const user = users.find(u => u.id === userId);
                    return {
                        name: user?.name || "Unknown",
                        email: user?.email || "N/A",
                        totalOrders: count
                    };
                })
                .sort((a, b) => b.totalOrders - a.totalOrders);

            const table = document.getElementById("most-orders-table");
            table.innerHTML = ""; 
            userList.forEach((u, i) => {
                const row = `<tr>
                    <td>${i + 1}</td>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${u.totalOrders}</td>
                </tr>`;
                table.innerHTML += row;
            });
        }

        function generateItemsSoldReport(orderItems, orders, restaurants) {
            const itemsSoldMap = {};

            orderItems.forEach(item => {
                const order = orders.find(o => o.id === item.orderId); 
                if (order) {
                    const restaurantId = order.restaurantId;
                    if (!itemsSoldMap[restaurantId]) {
                        itemsSoldMap[restaurantId] = 0;
                    }
                    itemsSoldMap[restaurantId] += item.quantity; 
                }
            });

            const itemsSoldList = Object.entries(itemsSoldMap)
                .map(([restaurantId, totalItemsSold]) => {
                    const restaurant = restaurants.find(r => r.id === restaurantId);
                    return {
                        name: restaurant?.name || "Unknown",
                        location: restaurant?.location || "N/A",
                        itemsSold: totalItemsSold
                    };
                })
                .sort((a, b) => b.itemsSold - a.itemsSold);

            const table = document.getElementById("items-sold-table");
            table.innerHTML = ""; 
            itemsSoldList.forEach((r, i) => {
                const row = `<tr>
                    <td>${i + 1}</td>
                    <td>${r.name}</td>
                    <td>${r.location}</td>
                    <td>${r.itemsSold}</td>
                </tr>`;
                table.innerHTML += row;
            });
        }

        function filterTables(searchTerm, restaurants, users) {
            const revenueTable = document.getElementById("highest-revenue-table");
            const revenueRows = Array.from(revenueTable.querySelectorAll("tr"));
            revenueRows.forEach(row => {
                const name = row.children[1]?.textContent.toLowerCase() || "";
                const location = row.children[2]?.textContent.toLowerCase() || "";
                row.style.display = name.includes(searchTerm) || location.includes(searchTerm) ? "" : "none";
            });

            const usersTable = document.getElementById("most-orders-table");
            const userRows = Array.from(usersTable.querySelectorAll("tr"));
            userRows.forEach(row => {
                const name = row.children[1]?.textContent.toLowerCase() || "";
                const email = row.children[2]?.textContent.toLowerCase() || "";
                row.style.display = name.includes(searchTerm) || email.includes(searchTerm) ? "" : "none";
            });

            const itemsSoldTable = document.getElementById("items-sold-table");
            const itemsSoldRows = Array.from(itemsSoldTable.querySelectorAll("tr"));
            itemsSoldRows.forEach(row => {
                const name = row.children[1]?.textContent.toLowerCase() || "";
                const location = row.children[2]?.textContent.toLowerCase() || "";
                row.style.display = name.includes(searchTerm) || location.includes(searchTerm) ? "" : "none";
            });
        }
    </script>
</body>
</html>

