<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reports - FoodExpress Admin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="mb-4">Reports</h1>
      <div class="mb-4">
        <input
          type="text"
          id="searchInput"
          class="form-control"
          placeholder="Search by name, email, or location"
        />
      </div>
      <div class="row">
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header bg-white">
              Restaurants with Highest Revenue
            </div>
            <div class="card-body">
              <table class="table">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Restaurant Name</th>
                    <th>Location</th>
                    <th>Total Revenue (₹)</th>
                  </tr>
                </thead>
                <tbody id="highest-revenue-table"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header bg-white">Users Who Order the Most</div>
            <div class="card-body">
              <table class="table">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>User Name</th>
                    <th>Email</th>
                    <th>Total Orders</th>
                  </tr>
                </thead>
                <tbody id="most-orders-table"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-lg-12 mb-4">
          <div class="card">
            <div class="card-header bg-white">Items Sold per Restaurant</div>
            <div class="card-body">
              <table class="table">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Restaurant Name</th>
                    <th>Location</th>
                    <th>Items Sold</th>
                  </tr>
                </thead>
                <tbody id="items-sold-table"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      (async () => {
        const apiUrl = "http://localhost:8080/api/reports"; // Adjusted to new report endpoints

        async function fetchHighestRevenueReport() {
          const response = await fetch(`${apiUrl}/highest-revenue`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: getAuthorization(),
            },
          });
          return response.json();
        }

        async function fetchMostOrdersReport() {
          const response = await fetch(`${apiUrl}/most-orders`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: getAuthorization(),
            },
          });
          return response.json();
        }

        async function fetchItemsSoldReport() {
          const response = await fetch(`${apiUrl}/items-sold`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: getAuthorization(),
            },
          });
          return response.json();
        }

        async function loadReports() {
          const [revenueList, mostOrdersList, itemsSoldList] =
            await Promise.all([
              fetchHighestRevenueReport(),
              fetchMostOrdersReport(),
              fetchItemsSoldReport(),
            ]);

          renderHighestRevenueReport(revenueList);
          renderMostOrdersReport(mostOrdersList);
          renderItemsSoldReport(itemsSoldList);

          const searchInput = document.getElementById("searchInput");
          searchInput.addEventListener("input", () => {
            const searchTerm = searchInput.value.toLowerCase();
            filterTables(searchTerm);
          });
        }

        loadReports();

        function renderHighestRevenueReport(data) {
          const table = document.getElementById("highest-revenue-table");
          table.innerHTML = "";
          data.forEach((r, i) => {
            const row = `<tr>
        <td>${i + 1}</td>
        <td>${r.name}</td>
        <td>${r.location}</td>
        <td>₹${r.revenue.toLocaleString()}</td>
      </tr>`;
            table.innerHTML += row;
          });
        }

        function renderMostOrdersReport(data) {
          const table = document.getElementById("most-orders-table");
          table.innerHTML = "";
          data.forEach((u, i) => {
            const row = `<tr>
        <td>${i + 1}</td>
        <td>${u.name}</td>
        <td>${u.email}</td>
        <td>${u.totalOrders}</td>
      </tr>`;
            table.innerHTML += row;
          });
        }

        function renderItemsSoldReport(data) {
          const table = document.getElementById("items-sold-table");
          table.innerHTML = "";
          data.forEach((r, i) => {
            const row = `<tr>
        <td>${i + 1}</td>
        <td>${r.name}</td>
        <td>${r.location}</td>
        <td>${r.itemsSold}</td>
      </tr>`;
            table.innerHTML += row;
          });
        }

        function filterTables(searchTerm) {
          const tables = [
            "highest-revenue-table",
            "most-orders-table",
            "items-sold-table",
          ];

          tables.forEach((tableId) => {
            const rows = document
              .getElementById(tableId)
              .querySelectorAll("tr");
            rows.forEach((row) => {
              const text = Array.from(row.children)
                .map((td) => td.textContent.toLowerCase())
                .join(" ");
              row.style.display = text.includes(searchTerm) ? "" : "none";
            });
          });
        }
      })();
    </script>
  </body>
</html>
