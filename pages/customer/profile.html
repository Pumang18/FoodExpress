<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Profile - FoodExpress</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- Navbar -->

    <div class="container mt-4">
      <div class="row">
        <div class="col-lg-4 mb-4">
          <div class="card profile-section">
            <div class="card-body text-center">
              <div class="mb-3">
                <i class="fas fa-user-circle fa-5x text-primary"></i>
              </div>
              <h4 id="profile-name">Loading...</h4>
              <p class="text-muted" id="profile-email">Loading...</p>
              <hr />
              <div class="text-start">
                <p>
                  <i class="fas fa-phone text-primary me-2"></i>
                  <span id="profile-phone">Loading...</span>
                </p>
                <p>
                  <i class="fas fa-map-marker-alt text-primary me-2"></i>
                  <span id="profile-address">Loading...</span>
                </p>
              </div>
              <button
                class="btn btn-outline-primary w-100 mt-3"
                data-bs-toggle="modal"
                data-bs-target="#editProfileModal"
              >
                <i class="fas fa-edit me-1"></i> Edit Profile
              </button>
              <button
                class="btn btn-outline-danger w-100 mt-3"
                data-bs-toggle="modal"
                data-bs-target="#editPasswordModal"
              >
                <i class="fas fa-key me-1"></i> Change Password
              </button>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <!-- Orders Section -->
          <div class="card mb-4">
            <div
              class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0">My Orders</h5>
              <span
                id="total-orders-badge"
                class="badge bg-light text-dark"
              ></span>
            </div>
            <div class="card-body p-0">
              <div id="no-orders-message" class="text-center py-5 d-none">
                <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                <h5>No orders yet</h5>
                <p class="text-muted">Your order history will appear here</p>
                <a href="home.html" class="btn btn-primary mt-2">Order Now</a>
              </div>
              <ul id="orders-container" class="list-group list-group-flush">
                <!-- Orders will be loaded here -->
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Profile Modal -->
    <div
      class="modal fade"
      id="editProfileModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Profile</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="profile-form">
              <div class="mb-3">
                <label for="name" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="name" value="" />
              </div>
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  value=""
                  readonly
                />
              </div>
              <div class="mb-3">
                <label for="phone" class="form-label">Phone</label>
                <input type="tel" class="form-control" id="phone" value="" />
              </div>
              <div class="mb-3">
                <label for="address" class="form-label">Address</label>
                <textarea class="form-control" id="address" rows="2"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="save-profile">
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Change Password Modal -->
    <div
      class="modal fade"
      id="editPasswordModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Change Password</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="password-form">
              <div class="mb-3">
                <label for="current-password" class="form-label"
                  >Current Password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="current-password"
                  placeholder="Enter current password"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="new-password" class="form-label"
                  >New Password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="new-password"
                  placeholder="Enter new password"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="confirm-password" class="form-label"
                  >Confirm New Password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="confirm-password"
                  placeholder="Confirm new password"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="save-password">
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Details Modal -->
    <div
      class="modal fade"
      id="orderDetailsModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Order Details</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="order-details-content"></div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      (() => {
        const userId = sessionStorage.getItem("userId");

        if (!userId) {
          console.error("User ID not found in sessionStorage");
          return;
        }

        const profileName = document.getElementById("profile-name");
        const profileEmail = document.getElementById("profile-email");
        const profilePhone = document.getElementById("profile-phone");
        const profileAddress = document.getElementById("profile-address");

        const nameInput = document.getElementById("name");
        const emailInput = document.getElementById("email");
        const phoneInput = document.getElementById("phone");
        const addressInput = document.getElementById("address");
        const saveProfileButton = document.getElementById("save-profile");
        let currentUser = null;

        fetch(`${apiUrl}/users/${userId}`)
          .then((response) => response.json())
          .then((user) => {
            currentUser = user;

            profileName.textContent = user.name;
            profileEmail.textContent = user.email;
            profilePhone.textContent = user.phone;
            profileAddress.textContent = user.address;

            nameInput.value = user.name;
            emailInput.value = user.email;
            phoneInput.value = user.phone;
            addressInput.value = user.address;
          });

        saveProfileButton.addEventListener("click", () => {
          const updatedUser = {
            ...currentUser,
            name: nameInput.value,
            phone: phoneInput.value,
            address: addressInput.value,
          };

          fetch(`${apiUrl}/users/${userId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updatedUser),
          })
            .then((response) => response.json())
            .then((updatedUser) => {
              profileName.textContent = updatedUser.name;
              profilePhone.textContent = updatedUser.phone;
              profileAddress.textContent = updatedUser.address;

              const editProfileModal = bootstrap.Modal.getInstance(
                document.getElementById("editProfileModal")
              );
              editProfileModal.hide();

              alert("Profile updated successfully!");
            });
        });

        const ordersContainer = document.getElementById("orders-container");
        const totalOrdersBadge = document.getElementById("total-orders-badge");
        const orderDetailsContent = document.getElementById(
          "order-details-content"
        );

        fetch(`${apiUrl}/orders?userId=${userId}`)
          .then((response) => response.json())
          .then((orders) => {
            const userOrders = orders;
            if (userOrders.length === 0) {
            } else {
              totalOrdersBadge.textContent = `Total Orders: ${userOrders.length}`;
              userOrders.forEach((order) => {
                const orderElement = document.createElement("li");
                orderElement.classList.add(
                  "list-group-item",
                  "order-list-item",
                  "d-flex",
                  "justify-content-between",
                  "align-items-center"
                );
                orderElement.innerHTML = `
                                <div>
                                    <h6 class="mb-0">Order ID: ${order.id}</h6>
                                    <p class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Date: ${
                                      order.orderDate
                                    }</p>
                                    <p class="mb-0"><i class="fas fa-indian-rupee me-2"></i>Total Amount: ₹${order.totalAmount.toFixed(
                                      2
                                    )}</p>
                                </div>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#orderDetailsModal" data-order-id="${
                                  order.id
                                }"><i class="fas fa-info-circle me-1"></i>Details</button>
                            `;
                ordersContainer.appendChild(orderElement);
              });
            }
          });

        ordersContainer.addEventListener("click", function (event) {
          if (event.target && event.target.matches("button[data-order-id]")) {
            const orderId = event.target.getAttribute("data-order-id");

            fetch(`${apiUrl}/orderItems?orderId=${orderId}`)
              .then((response) => response.json())
              .then((orderItems) => {
                let itemsHtml = "";
                let itemsProcessed = 0;

                orderItems.forEach((orderItem) => {
                  fetch(`${apiUrl}/foodItems/${orderItem.itemId}`)
                    .then((response) => response.json())
                    .then((itemDetails) => {
                      itemsHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          <div>
                            <strong>${itemDetails.name}</strong>
                            <div>Quantity: ${orderItem.quantity}</div>
                          </div>
                          <span class="badge bg-primary rounded-pill">₹${itemDetails.price}</span>
                        </li>
                      `;

                      itemsProcessed++;

                      if (itemsProcessed === orderItems.length) {
                        orderDetailsContent.innerHTML = `
                          <h6 class="mb-3">Order ID: ${orderId}</h6>
                          <ul class="list-group list-group-flush">${itemsHtml}</ul>
                        `;
                      }
                    });
                });
              });
          }
        });

        const savePasswordButton = document.getElementById("save-password");

        savePasswordButton.addEventListener("click", () => {
          const currentPasswordInput =
            document.getElementById("current-password");
          const newPasswordInput = document.getElementById("new-password");
          const confirmPasswordInput =
            document.getElementById("confirm-password");

          const currentPassword = currentPasswordInput.value.trim();
          const newPassword = newPasswordInput.value.trim();
          const confirmPassword = confirmPasswordInput.value.trim();

          if (!currentPassword || !newPassword || !confirmPassword) {
            alert("All fields are required.");
            return;
          }

          if (newPassword !== confirmPassword) {
            alert("New password and confirm password do not match.");
            return;
          }

          fetch("http://localhost:8080/api/users/change-password", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: currentUser.email, // dynamically get logged-in user's email
              currentPassword: currentPassword,
              newPassword: newPassword,
            }),
          })
            .then((response) => {
              if (!response.ok) {
                return response.text().then((msg) => {
                  alert(msg);
                  throw new Error(msg);
                });
              }
              return response.text();
            })
            .then((msg) => {
              bootstrap.Modal.getInstance(
                document.getElementById("editPasswordModal")
              ).hide();
              currentPasswordInput.value = "";
              newPasswordInput.value = "";
              confirmPasswordInput.value = "";
              alert(msg);
            })
            .catch((err) => console.error(err));
        });
      })();
    </script>
  </body>
</html>
`
