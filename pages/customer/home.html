<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Home - FoodExpress</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- Restaurant List Section -->
    <section id="restaurants-list-section">
      <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Restaurants</h2>
          <div class="d-flex">
            <div class="input-group me-2" style="width: 300px">
              <input
                type="text"
                class="form-control"
                placeholder="Search restaurants..."
                id="searchInput"
              />
              <button class="btn btn-outline-primary" type="button">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="row" id="restaurantList">
          <!-- Restaurant cards will be dynamically loaded -->
        </div>
      </div>
    </section>

    <!-- Restaurant Info Section -->
    <section id="restaurant-info-section" class="d-none">
      <div class="container mt-4">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="#" id="back-to-restaurants">Restaurants</a>
            </li>
            <li
              class="breadcrumb-item active"
              aria-current="page"
              id="restaurant-name"
            >
              Restaurant Name
            </li>
          </ol>
        </nav>
        <div class="card mb-4">
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 text-center text-md-start">
                <img
                  src=""
                  class="img-fluid rounded"
                  id="restaurant-image"
                  alt="Restaurant"
                />
              </div>
              <div class="col-md-8">
                <h2 id="restaurant-title">Restaurant Name</h2>
                <p>
                  <i class="fas fa-map-marker-alt text-primary me-2"></i>
                  <span id="restaurant-location">Location</span>
                </p>
                <p>
                  <i class="fas fa-phone text-primary me-2"></i>
                  <span id="restaurant-contact">Contact</span>
                </p>
              </div>
            </div>
          </div>
        </div>
        <div class="row mb-4">
          <div class="col-12">
            <ul class="nav nav-pills" id="menuCategories" role="tablist">
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link active"
                  id="appetizers-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#appetizers"
                  type="button"
                  role="tab"
                >
                  Appetizers
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="main-courses-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#main-courses"
                  type="button"
                  role="tab"
                >
                  Main Courses
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="desserts-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#desserts"
                  type="button"
                  role="tab"
                >
                  Desserts
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="drinks-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#drinks"
                  type="button"
                  role="tab"
                >
                  Drinks
                </button>
              </li>
            </ul>
          </div>
        </div>
        <div class="tab-content" id="menuContent">
          <div
            class="tab-pane fade show active"
            id="appetizers"
            role="tabpanel"
          >
            <div class="row" id="appetizers-list"></div>
          </div>
          <div class="tab-pane fade" id="main-courses" role="tabpanel">
            <div class="row" id="main-courses-list"></div>
          </div>
          <div class="tab-pane fade" id="desserts" role="tabpanel">
            <div class="row" id="dessert-list"></div>
          </div>
          <div class="tab-pane fade" id="drinks" role="tabpanel">
            <div class="row" id="drink-list"></div>
          </div>
        </div>
      </div>
      
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      (() => {
        const apiUrl = "http://localhost:3000";
        const restaurantListSection = document.getElementById("restaurants-list-section");
        const restaurantInfoSection = document.getElementById("restaurant-info-section");
        const searchInput = document.getElementById("searchInput");
        const restaurantList = document.getElementById("restaurantList");
        const menuContent = document.getElementById("menuContent");
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        let restaurants = [];
        let currentRestaurant = null;

        // Initialize the application
        function init() {
          fetchRestaurants();
          setupEventListeners();
          updateCartCount();
        }

        // Fetch restaurants from the API
        function fetchRestaurants() {
          fetch(`${apiUrl}/restaurants`)
            .then((response) => response.json())
            .then((data) => {
              restaurants = data;
              displayRestaurants(restaurants);
            })
            .catch((error) => console.error("Error fetching restaurants:", error));
        }

        // Display restaurants in the list
        function displayRestaurants(restaurants) {
          restaurantList.innerHTML = restaurants
            .map(
              (restaurant) => `
              <div class="col-md-4 mb-4">
                <div class="card h-100">
                  <div class="card-body">
                    <h5 class="card-title">${restaurant.name}</h5>
                    <p class="card-text mb-1">
                      <i class="fas fa-map-marker-alt text-primary me-1"></i> ${restaurant.location}
                    </p>
                    <button class="btn btn-primary w-100 view-menu-btn" 
                            data-id="${restaurant.id}" 
                            data-name="${restaurant.name}" 
                            data-location="${restaurant.location}" 
                            data-contact="${restaurant.contact}">
                      View Menu
                    </button>
                  </div>
                </div>
              </div>
            `
            )
            .join("");

          document.querySelectorAll(".view-menu-btn").forEach((button) => {
            button.addEventListener("click", handleViewMenuClick);
          });
        }

        // Handle "View Menu" button click
        function handleViewMenuClick(event) {
          const button = event.target;
          const restaurantId = button.getAttribute("data-id");
          const restaurantName = button.getAttribute("data-name");
          const restaurantLocation = button.getAttribute("data-location");
          const restaurantContact = button.getAttribute("data-contact");
          
          currentRestaurant = restaurants.find((r) => r.id === restaurantId);

          updateRestaurantInfo(restaurantName, restaurantLocation, restaurantContact);
          fetchMenuItems(restaurantId);
          restaurantListSection.classList.add("d-none");
          restaurantInfoSection.classList.remove("d-none");
        }

        // Update restaurant info section
        function updateRestaurantInfo(name, location, contact) {
          document.getElementById("restaurant-title").textContent = name;
          document.getElementById("restaurant-location").textContent = location;
          document.getElementById("restaurant-contact").textContent = contact;
        }

        // Fetch menu items for a restaurant
        function fetchMenuItems(restaurantId) {
          fetch(`${apiUrl}/foodItems`)
            .then((response) => response.json())
            .then((foodItems) => {
              const filteredItems = foodItems.filter((item) => item.restaurantId === restaurantId);
              displayMenuItems(filteredItems);
            })
            .catch((error) => console.error("Error fetching menu items:", error));
        }

        // Display menu items in categories
        function displayMenuItems(items) {
          const categories = ["appetizers", "main-courses", "dessert", "drink"];
          categories.forEach((category) => {
            const container = document.getElementById(`${category}-list`);
            container.innerHTML = items
              .filter((item) => item.category === category)
              .map(
                (item) => `
                <div class="col-md-4 mb-4">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body">
                      <h5 class="card-title">${item.name}</h5>
                      <p class="card-text text-muted">Price: ₹${item.price}</p>
                      <div class="input-group mb-3">
                        <button class="btn btn-outline-secondary" type="button" onclick="decreaseQty(this)">−</button>
                        <input type="text" class="form-control text-center" value="1" readonly />
                        <button class="btn btn-outline-secondary" type="button" onclick="increaseQty(this)">+</button>
                      </div>
                      <button class="btn btn-primary w-100 add-to-cart" 
                              data-item-id="${item.id}" 
                              data-item-name="${item.name}" 
                              data-item-price="${item.price}">
                        Add to Cart
                      </button>
                    </div>
                  </div>
                </div>
              `
              )
              .join("");
          });
        }

        

        // Handle "Add to Cart" button click
        function handleAddToCart(event) {
          if (!event.target.classList.contains("add-to-cart")) return;

          const button = event.target;
          const itemId = button.getAttribute("data-item-id");
          const itemName = button.getAttribute("data-item-name");
          const itemPrice = parseFloat(button.getAttribute("data-item-price"));
          const card = button.closest(".card");
          const quantity = parseInt(card.querySelector("input").value);

          const currentRestaurantName = currentRestaurant.name;

          // Check for different restaurant
          if (cart.length > 0 && cart[0].restaurant !== currentRestaurantName) {
            const proceed = confirm(
              `Your cart contains items from "${cart[0].restaurant}".\n` +
                `Do you want to clear the cart and add items from "${currentRestaurantName}" instead?`
            );
            if (!proceed) return;

            // Clear cart
            cart.length = 0;
          }

          const existingItem = cart.find((item) => item.id === itemId);

          if (existingItem) {
            existingItem.quantity += quantity;
          } else {
            cart.push({
              id: itemId,
              name: itemName,
              price: itemPrice,
              quantity: quantity,
              restaurant: currentRestaurantName,
              restaurantId: currentRestaurant.id,
            });
          }

          localStorage.setItem("cart", JSON.stringify(cart));
          updateCartCount();

          button.innerHTML = '<i class="fas fa-check"></i> Added';
          button.classList.remove("btn-primary");
          button.classList.add("btn-success");
          setTimeout(() => {
            button.innerHTML = "Add to Cart";
            button.classList.remove("btn-success");
            button.classList.add("btn-primary");
          }, 1500);
        }

        // Update cart count
        function updateCartCount() {
          const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
          localStorage.setItem("cartCount", totalItems);
          document.querySelectorAll(".cart-count").forEach((el) => {
            el.textContent = totalItems;
          });
        }

        // Setup event listeners
        function setupEventListeners() {
          searchInput.addEventListener("input", handleSearch);
          document.getElementById("back-to-restaurants").addEventListener("click", () => {
            restaurantListSection.classList.remove("d-none");
            restaurantInfoSection.classList.add("d-none");
          });
          menuContent.addEventListener("click", handleAddToCart);
        }

        // Handle search input
        function handleSearch() {
          const query = searchInput.value.toLowerCase();
          const filteredRestaurants = restaurants.filter(
            (restaurant) =>
              restaurant.name.toLowerCase().includes(query) ||
              restaurant.location.toLowerCase().includes(query)
          );
          displayRestaurants(filteredRestaurants);
        }

        // Quantity functions
        window.increaseQty = (btn) => {
          const input = btn.parentElement.querySelector("input");
          input.value = parseInt(input.value) + 1;
        };

        window.decreaseQty = (btn) => {
          const input = btn.parentElement.querySelector("input");
          if (parseInt(input.value) > 1) {
            input.value = parseInt(input.value) - 1;
          }
        };

        // Initialize the app
        init();
      })();
    </script>
  </body>
</html>
